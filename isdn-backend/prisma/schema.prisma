// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

model User {
  id                 BigInt    @id @default(autoincrement())
  username           String    @unique
  email              String    @unique
  password           String
  roleId             BigInt    @map("role_id")
  name               String
  contactNumber      String    @map("contact_number")
  
  // Customer-specific
  businessName       String?   @map("business_name")
  customerCode       String?   @unique @map("customer_code")
  address            String?   @db.Text
  district           String?
  customerType       String?   @map("customer_type") // Retail, Supermarket, Reseller
  assignedBranchId   BigInt?   @map("assigned_branch_id")
  
  // Internal-user-specific
  branchId           BigInt?   @map("branch_id")
  
  // Driver-specific
  vehicleId          BigInt?   @map("vehicle_id")
  licenseNumber      String?   @map("license_number")
  
  active             Boolean   @default(true)
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  role               Role      @relation(fields: [roleId], references: [id])
  branch             Branch?   @relation("UserBranch", fields: [branchId], references: [id])
  assignedBranch     Branch?   @relation("CustomerAssignedBranch", fields: [assignedBranchId], references: [id])
  vehicle            Vehicle?  @relation(fields: [vehicleId], references: [id])
  
  orders             Order[]
  deliveries         Delivery[] @relation("DriverDeliveries")
  invoices           Invoice[]
  paymentsCollected  Payment[]  @relation("CollectedBy")

  @@map("user")
}

model Role {
  id          BigInt   @id @default(autoincrement())
  roleName    String   @map("role_name")
  permissions String   @db.Text // JSON string
  active      Boolean  @default(true)
  users       User[]

  @@map("role")
}

model Branch {
  id               BigInt          @id @default(autoincrement())
  name             String
  code             String          @unique
  region           String
  address          String
  contactNumber    String          @map("contact_number")
  active           Boolean         @default(true)

  // Relations
  users            User[]          @relation("UserBranch")
  assignedCustomers User[]         @relation("CustomerAssignedBranch")
  vehicles         Vehicle[]
  inventories      Inventory[]
  orders           Order[]
  transfersFrom    StockTransfer[] @relation("FromBranch")
  transfersTo      StockTransfer[] @relation("ToBranch")

  @@map("branch")
}

model Vehicle {
  id            BigInt     @id @default(autoincrement())
  vehicleNumber String     @unique @map("vehicle_number")
  vehicleType   String     @map("vehicle_type")
  brand         String
  capacityKg    Decimal    @map("capacity_kg") @db.Decimal(10, 2)
  branchId      BigInt     @map("branch_id")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  branch        Branch     @relation(fields: [branchId], references: [id])
  users         User[]
  deliveries    Delivery[]

  @@map("vehicle")
}

model Product {
  id            BigInt     @id @default(autoincrement())
  productCode   String     @unique @map("product_code")
  name          String
  category      String
  unitPrice     Decimal    @map("unit_price") @db.Decimal(10, 2)
  unitType      String     @map("unit_type")
  promotionId   BigInt?    @map("promotion_id")
  description   String?    @db.Text
  imageUrl      String?    @map("image_url")
  active        Boolean    @default(true)

  // Relations
  promotion     Promotion? @relation(fields: [promotionId], references: [id])
  inventories   Inventory[]
  orderItems    OrderItem[]
  stockTransfers StockTransfer[]

  @@map("product")
}

model Inventory {
  id               BigInt   @id @default(autoincrement())
  productId        BigInt   @map("product_id")
  branchId         BigInt   @map("branch_id")
  quantity         Int
  reservedQuantity Int      @default(0) @map("reserved_quantity")
  lastUpdated      DateTime @default(now()) @updatedAt @map("last_updated")

  product          Product  @relation(fields: [productId], references: [id])
  branch           Branch   @relation(fields: [branchId], references: [id])

  @@map("inventory")
}

model StockTransfer {
  id             BigInt   @id @default(autoincrement())
  productId      BigInt   @map("product_id")
  fromBranchId   BigInt   @map("from_branch_id")
  toBranchId     BigInt   @map("to_branch_id")
  quantity       Int
  transferDate   DateTime @map("transfer_date")
  status         String
  notes          String?  @db.Text

  product        Product  @relation(fields: [productId], references: [id])
  fromBranch     Branch   @relation("FromBranch", fields: [fromBranchId], references: [id])
  toBranch       Branch   @relation("ToBranch", fields: [toBranchId], references: [id])

  @@map("stock_transfer")
}

model Order {
  id           BigInt      @id @default(autoincrement())
  orderNumber  String      @unique @map("order_number")
  userId       BigInt      @map("user_id")
  branchId     BigInt      @map("branch_id")
  orderDate    DateTime    @default(now()) @map("order_date")
  status       String      // Pending, Confirmed, etc.
  totalAmount  Decimal     @map("total_amount") @db.Decimal(10, 2)
  deliveryDate DateTime?   @map("delivery_date")
  specialNotes String?     @db.Text @map("special_notes")
  createdAt    DateTime    @default(now()) @map("created_at")

  user         User        @relation(fields: [userId], references: [id])
  branch       Branch      @relation(fields: [branchId], references: [id])
  items        OrderItem[]
  deliveries   Delivery[]
  invoices     Invoice[]

  @@map("orders")
}

model OrderItem {
  id         BigInt  @id @default(autoincrement())
  orderId    BigInt  @map("order_id")
  productId  BigInt  @map("product_id")
  quantity   Int
  unitPrice  Decimal @map("unit_price") @db.Decimal(10, 2)
  subtotal   Decimal @db.Decimal(10, 2)

  order      Order   @relation(fields: [orderId], references: [id])
  product    Product @relation(fields: [productId], references: [id])

  @@map("order_item")
}

model Delivery {
  id                BigInt    @id @default(autoincrement())
  deliveryNumber    String    @unique @map("delivery_number")
  orderId           BigInt    @map("order_id")
  driverId          BigInt    @map("driver_id")
  vehicleId         BigInt    @map("vehicle_id")
  deliveryDate      DateTime  @map("delivery_date")
  departureTime     DateTime? @map("departure_time")
  status            String    // Scheduled, In_Transit, etc.
  gpsLocation       String?   @map("gps_location")
  deliveryTime      DateTime? @map("delivery_time")
  recipientName     String?   @map("recipient_name")
  recipientSignature String?  @map("recipient_signature")
  notes             String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")

  order             Order     @relation(fields: [orderId], references: [id])
  driver            User      @relation("DriverDeliveries", fields: [driverId], references: [id])
  vehicle           Vehicle   @relation(fields: [vehicleId], references: [id])

  @@map("delivery")
}

model Invoice {
  id            BigInt    @id @default(autoincrement())
  invoiceNumber String    @unique @map("invoice_number")
  orderId       BigInt    @map("order_id")
  customerId    BigInt    @map("customer_id")
  invoiceDate   DateTime  @map("invoice_date")
  dueDate       DateTime? @map("due_date")
  totalAmount   Decimal   @map("total_amount") @db.Decimal(10, 2)
  taxAmount     Decimal   @map("tax_amount") @db.Decimal(10, 2)
  netAmount     Decimal   @map("net_amount") @db.Decimal(10, 2)
  status        String
  createdAt     DateTime  @default(now()) @map("created_at")

  order         Order     @relation(fields: [orderId], references: [id])
  customer      User      @relation(fields: [customerId], references: [id])
  payments      Payment[]

  @@map("invoice")
}

model Payment {
  id              BigInt   @id @default(autoincrement())
  invoiceId       BigInt   @map("invoice_id")
  paymentDate     DateTime @map("payment_date")
  amount          Decimal  @db.Decimal(10, 2)
  paymentMethod   String   @map("payment_method")
  referenceNumber String?  @map("reference_number")
  collectedBy     BigInt   @map("collected_by")
  status          String
  notes           String?  @db.Text

  invoice         Invoice  @relation(fields: [invoiceId], references: [id])
  collector       User     @relation("CollectedBy", fields: [collectedBy], references: [id])

  @@map("payment")
}

model Promotion {
  id              BigInt    @id @default(autoincrement())
  title           String
  discountPercent Decimal   @map("discount_percent") @db.Decimal(5, 2)
  startDate       DateTime  @map("start_date")
  endDate         DateTime  @map("end_date")
  active          Boolean   @default(true)
  products        Product[]

  @@map("promotion")
}

model BlacklistedToken {
  id        BigInt   @id @default(autoincrement())
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([expiresAt])
  @@map("blacklisted_token")
}
